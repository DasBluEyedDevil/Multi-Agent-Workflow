---
phase: 10-enhanced-skill
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - skills/lib/model-rules.json
  - skills/lib/task-classifier.sh
autonomous: true

must_haves:
  truths:
    - "File extensions correctly map to K2 or K2.5 models"
    - "Task descriptions are classified as routine, creative, or unknown"
    - "Configuration is loadable by bash scripts via jq"
  artifacts:
    - path: "skills/lib/model-rules.json"
      provides: "Extension to model mapping configuration"
      min_lines: 30
      contains: '"k2.5"'  
    - path: "skills/lib/task-classifier.sh"
      provides: "Task type classification functions"
      min_lines: 80
      exports: ["classify_task", "detect_code_patterns"]
  key_links:
    - from: "task-classifier.sh"
      to: "model-rules.json"
      via: "source/load_json"
      pattern: "jq.*model-rules"
---

<objective>
Create the foundational configuration and classification system for intelligent model selection.

Purpose: Establish the data and logic needed to map file extensions and task types to appropriate models (K2 for routine, K2.5 for creative/UI).
Output: model-rules.json with extension mappings and task-classifier.sh with classification functions.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/phases/10-enhanced-skill/10-RESEARCH.md
@skills/kimi.agent.wrapper.sh

Phase 10 implements smart triggers for autonomous delegation. This plan creates the foundational components that subsequent plans will integrate.

From RESEARCH.md:
- File extension mapping: UI files (.tsx, .jsx, .css, .vue) → K2.5; backend files (.py, .js, .go) → K2
- Task classification: Keyword-based patterns for routine vs creative work
- Code pattern detection: Component creation patterns boost K2.5 score
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create model-rules.json configuration</name>
  <files>skills/lib/model-rules.json</files>
  <action>
Create skills/lib/model-rules.json with the following structure:

1. Extension mappings object with two keys: "k2" and "k2.5"
2. K2.5 extensions (creative/UI): .tsx, .jsx, .css, .scss, .sass, .less, .vue, .svelte, .html, .htm, .svg
3. K2 extensions (routine/backend): .py, .js, .ts, .go, .rs, .java, .rb, .php, .cs, .cpp, .c, .h, .hpp, .swift, .kt, .scala, .sh, .bash, .zsh, .fish, .ps1
4. Pattern overrides for test files: *.test.*, *.spec.*, *_test.* → k2 (tests are routine)
5. Pattern overrides for component files: *component* → k2.5 (component work is creative)

Use this exact structure:
{
  "version": "1.0",
  "extensions": {
    "k2": ["py", "js", "ts", ...],
    "k2.5": ["tsx", "jsx", "css", ...]
  },
  "patterns": {
    "k2": ["*.test.*", "*.spec.*", "*_test.*"],
    "k2.5": ["*component*", "*Component*"]
  },
  "defaults": {
    "model": "k2",
    "confidence_threshold": 75
  }
}

Ensure the JSON is valid (test with jq). Use lowercase extensions consistently.
  </action>
  <verify>jq . skills/lib/model-rules.json && echo "JSON is valid"</verify>
  <done>model-rules.json exists with valid JSON containing extension mappings for k2 and k2.5, pattern overrides, and default settings</done>
</task>

<task type="auto">
  <name>Task 2: Create task-classifier.sh with classification functions</name>
  <files>skills/lib/task-classifier.sh</files>
  <action>
Create skills/lib/task-classifier.sh as a bash library with these exported functions:

1. classify_task(task_description)
   - Convert input to lowercase
   - Check for routine patterns: refactor|test|testing|fix.*bug|debug|optimize|lint|format|extract.*method|rename|move.*file|cleanup|audit|review|analyze|verify
   - Check for creative patterns: implement.*feature|create.*component|design|ui|ux|style|layout|animation|responsive|theme|component|build.*interface|visual|frontend
   - Return: "routine", "creative", or "unknown"

2. detect_code_patterns(file_paths...)
   - For each file path, check for component patterns
   - React component: contains "export.*function|export.*const.*=|class.*extends.*Component|export default"
   - Vue component: file ends with .vue
   - CSS module: file ends with .module.css or contains styled-components patterns
   - Return: "component", "utility", or "unknown"

3. load_model_rules()
   - Load skills/lib/model-rules.json using jq
   - Return: JSON content or empty on error

4. get_model_for_extension(extension)
   - Takes file extension (with or without dot)
   - Query model-rules.json via jq
   - Return: "k2", "k2.5", or default

Include proper error handling and stderr logging. Add header comment with usage examples. Make functions exportable for sourcing.

Follow bash conventions from existing codebase:
- Use verb_noun function names
- UPPERCASE for constants
- lowercase for local variables
- Proper quoting and error handling
  </action>
  <verify>bash -n skills/lib/task-classifier.sh && echo "Syntax OK"</verify>
  <done>task-classifier.sh exists with classify_task, detect_code_patterns, load_model_rules, and get_model_for_extension functions, valid bash syntax</done>
</task>

</tasks>

<verification>
1. model-rules.json is valid JSON: `jq . skills/lib/model-rules.json > /dev/null`
2. task-classifier.sh has valid syntax: `bash -n skills/lib/task-classifier.sh`
3. Functions can be sourced and tested:
   - `source skills/lib/task-classifier.sh && classify_task "refactor this code"` returns "routine"
   - `source skills/lib/task-classifier.sh && classify_task "create a component"` returns "creative"
   - `source skills/lib/task-classifier.sh && get_model_for_extension "tsx"` returns "k2.5"
   - `source skills/lib/task-classifier.sh && get_model_for_extension "py"` returns "k2"
</verification>

<success_criteria>
- model-rules.json exists with complete extension mappings
- task-classifier.sh has all required functions with correct behavior
- Classification correctly identifies routine vs creative tasks
- Extension lookup returns appropriate model for UI vs backend files
</success_criteria>

<output>
After completion, create `.planning/phases/10-enhanced-skill/10-01-SUMMARY.md`
</output>
