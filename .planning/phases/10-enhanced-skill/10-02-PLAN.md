---
phase: 10-enhanced-skill
plan: 02
type: execute
wave: 2
depends_on: ["10-01"]
files_modified:
  - skills/kimi-model-selector.sh
autonomous: true

must_haves:
  truths:
    - "Model selection combines file extension and task type signals"
    - "Confidence score reflects certainty of model choice (0-100)"
    - "User override via KIMI_FORCE_MODEL takes precedence"
  artifacts:
    - path: "skills/kimi-model-selector.sh"
      provides: "Main model selection logic"
      min_lines: 150
      exports: ["select_model", "calculate_confidence", "check_user_override"]
  key_links:
    - from: "kimi-model-selector.sh"
      to: "skills/lib/task-classifier.sh"
      via: "source"
      pattern: "source.*task-classifier"
    - from: "kimi-model-selector.sh"
      to: "skills/lib/model-rules.json"
      via: "jq"
      pattern: "jq.*model-rules"
---

<objective>
Implement the core model selection engine with multi-factor scoring and confidence calculation.

Purpose: Create the decision engine that analyzes tasks and selects the appropriate model (K2 for routine, K2.5 for creative) with confidence scoring.
Output: kimi-model-selector.sh with select_model, calculate_confidence, and override detection functions.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/10-enhanced-skill/10-RESEARCH.md
@.planning/phases/10-enhanced-skill/10-01-PLAN.md
@skills/lib/task-classifier.sh (from 10-01)
@skills/lib/model-rules.json (from 10-01)

This plan builds on 10-01's foundation to create the selection logic. The selector combines:
- File extension signals (from model-rules.json)
- Task type classification (from task-classifier.sh)
- Code pattern detection (for component work)

Research-derived confidence formula:
- Base: 50 points
- +20 if all files agree on model
- +20 if task type is clear (not unknown)
- +10 if code patterns match selected model
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create kimi-model-selector.sh with selection logic</name>
  <files>skills/kimi-model-selector.sh</files>
  <action>
Create skills/kimi-model-selector.sh as the main model selection script:

1. Source skills/lib/task-classifier.sh at the top

2. Implement select_model(task_description, file_paths...)
   - Initialize k2_score=0, k2_5_score=0
   - For each file: extract extension, get model preference, increment appropriate score
   - Get task classification (routine/creative/unknown)
   - If routine: k2_score += 2
   - If creative: k2_5_score += 2
   - Detect code patterns in files (if readable)
   - If component patterns found: k2_5_score += 1
   - Return model with higher score (default to k2 on tie)

3. Implement calculate_confidence(task_description, file_paths..., selected_model)
   - Start with base confidence of 50
   - Check if all files agree on selected_model: +20 if yes
   - Check task classification: +20 if not "unknown"
   - Check code patterns: +10 if patterns match selected_model
   - Cap at 100, minimum 0
   - Return confidence integer

4. Implement check_user_override()
   - Check KIMI_FORCE_MODEL environment variable
   - If set and valid (k2 or k2.5), return that value
   - Otherwise return empty string
   - Log override usage to stderr

5. Implement main selection pipeline function select_model_with_confidence()
   - Takes task description and file list
   - Checks for user override first
   - Calls select_model to get recommendation
   - Calls calculate_confidence for certainty score
   - Returns JSON: {"model": "k2|k2.5", "confidence": N, "override": true|false}

6. Add CLI interface for testing:
   - --task "description"
   - --files "file1,file2,..."
   - --json (output JSON)
   - Returns model recommendation

Include proper error handling, stderr logging with [model-selector] prefix, and exit codes:
- 0: success
- 10: invalid arguments
- 11: config file not found

Follow bash conventions: verb_noun functions, UPPERCASE constants, proper quoting.
  </action>
  <verify>bash -n skills/kimi-model-selector.sh && echo "Syntax OK"</verify>
  <done>kimi-model-selector.sh exists with select_model, calculate_confidence, check_user_override functions, valid bash syntax, sources task-classifier.sh</done>
</task>

<task type="auto">
  <name>Task 2: Test model selection with sample inputs</name>
  <files>skills/kimi-model-selector.sh</files>
  <action>
Test the model selector with various inputs to verify correct behavior:

1. Test routine task with backend files:
   - Task: "refactor the authentication module"
   - Files: src/auth.py, src/utils.py
   - Expected: model=k2, confidence >= 70

2. Test creative task with UI files:
   - Task: "create a responsive navigation component"
   - Files: src/Nav.tsx, src/Nav.css
   - Expected: model=k2.5, confidence >= 70

3. Test mixed files (tie-breaker to k2):
   - Task: "fix bug in user service"
   - Files: src/User.tsx, src/user.py
   - Expected: model=k2 (tie-breaker), confidence lower

4. Test user override:
   - Set KIMI_FORCE_MODEL=k2.5
   - Run any selection
   - Expected: model=k2.5, override=true

5. Test unclear task:
   - Task: "do something"
   - Files: none
   - Expected: model=k2 (default), confidence around 50

Use the CLI interface: ./skills/kimi-model-selector.sh --task "..." --files "..." --json

Verify JSON output format matches expected structure.
  </action>
  <verify>./skills/kimi-model-selector.sh --task "refactor code" --files "test.py" --json | jq -e '.model'</verify>
  <done>Model selector tested with 5 scenarios, all produce expected model selections and confidence scores, JSON output is valid</done>
</task>

</tasks>

<verification>
1. Script has valid syntax: `bash -n skills/kimi-model-selector.sh`
2. Can be executed: `chmod +x skills/kimi-model-selector.sh && ./skills/kimi-model-selector.sh --help`
3. Selection works for routine tasks: `./skills/kimi-model-selector.sh --task "refactor python code" --files "test.py" --json | jq -e '.model == "k2"'`
4. Selection works for creative tasks: `./skills/kimi-model-selector.sh --task "create react component" --files "Component.tsx" --json | jq -e '.model == "k2.5"'`
5. User override works: `KIMI_FORCE_MODEL=k2.5 ./skills/kimi-model-selector.sh --task "anything" --json | jq -e '.override == true'`
6. Confidence is calculated: `./skills/kimi-model-selector.sh --task "refactor" --files "test.py" --json | jq -e '.confidence >= 0 and .confidence <= 100'`
</verification>

<success_criteria>
- Model selector correctly chooses K2 for routine/backend tasks
- Model selector correctly chooses K2.5 for creative/UI tasks
- Confidence scores reflect certainty (high for clear signals, low for ambiguous)
- User override via KIMI_FORCE_MODEL works and is reported
- JSON output is valid and parseable
</success_criteria>

<output>
After completion, create `.planning/phases/10-enhanced-skill/10-02-SUMMARY.md`
</output>
