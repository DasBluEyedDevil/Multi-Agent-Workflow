---
phase: 10-enhanced-skill
plan: 03
type: execute
wave: 3
depends_on: ["10-01", "10-02"]
files_modified:
  - skills/kimi-cost-estimator.sh
  - skills/kimi.agent.wrapper.sh
autonomous: true

must_haves:
  truths:
    - "Cost estimation displays before delegation when confidence is low"
    - "Token estimate uses character count / 4 heuristic"
    - "K2.5 has 1.5x cost multiplier over K2"
    - "Context preservation uses kimi CLI --session flag"
  artifacts:
    - path: "skills/kimi-cost-estimator.sh"
      provides: "Cost estimation logic"
      min_lines: 80
      exports: ["estimate_cost", "display_cost", "estimate_tokens"]
    - path: "skills/kimi.agent.wrapper.sh"
      provides: "Enhanced wrapper with auto-model selection"
      contains: ["auto_select_model", "KIMI_FORCE_MODEL"]
  key_links:
    - from: "kimi.agent.wrapper.sh"
      to: "kimi-model-selector.sh"
      via: "source or call"
      pattern: "select_model|model-selector"
    - from: "kimi.agent.wrapper.sh"
      to: "kimi-cost-estimator.sh"
      via: "source or call"
      pattern: "estimate_cost|cost-estimator"
---

<objective>
Implement cost estimation and integrate model selection into the main wrapper.

Purpose: Add cost estimation before delegation and integrate intelligent model selection into the existing wrapper script.
Output: kimi-cost-estimator.sh and enhanced kimi.agent.wrapper.sh with auto-delegation support.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/10-enhanced-skill/10-RESEARCH.md
@.planning/phases/10-enhanced-skill/10-02-PLAN.md
@skills/kimi-model-selector.sh (from 10-02)
@skills/kimi.agent.wrapper.sh (existing)

This plan integrates the model selection into the existing wrapper. Key integration points:
- Add --auto-model flag to wrapper for automatic selection
- Add --show-cost flag to display estimates before delegation
- Use KIMI_FORCE_MODEL for override (already in selector)
- Use kimi CLI --session for context preservation

Cost estimation from research:
- tokens â‰ˆ characters / 4
- K2.5 multiplier = 1.5x
- Display in human-readable format
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create kimi-cost-estimator.sh</name>
  <files>skills/kimi-cost-estimator.sh</files>
  <action>
Create skills/kimi-cost-estimator.sh with cost estimation functions:

1. estimate_tokens(text_content)
   - Count characters in input
   - Return characters / 4 (integer division)

2. estimate_cost(prompt, file_paths..., model)
   - Count prompt characters
   - For each file: if readable, add file size in characters
   - Calculate total tokens: total_chars / 4
   - Apply model multiplier: k2=1.0, k2.5=1.5
   - Return normalized cost units (integer)

3. display_cost(cost_units, model)
   - Format for human readability
   - < 1000 tokens: "~N tokens (fast)"
   - 1000-5000 tokens: "~N tokens (moderate)"
   - > 5000 tokens: "~N tokens (may take time)"
   - Include model name in output

4. should_prompt_user(confidence, cost_units)
   - If confidence < 75 OR cost_units > 10000: return true
   - Otherwise: return false
   - Thresholds configurable via env vars

5. Add CLI interface:
   - --prompt "text" (required)
   - --files "file1,file2" (optional)
   - --model k2|k2.5 (default: k2)
   - --json (output JSON)

Include stderr logging with [cost-estimator] prefix. Follow bash conventions.
  </action>
  <verify>bash -n skills/kimi-cost-estimator.sh && echo "Syntax OK"</verify>
  <done>kimi-cost-estimator.sh exists with estimate_tokens, estimate_cost, display_cost, should_prompt_user functions, valid bash syntax</done>
</task>

<task type="auto">
  <name>Task 2: Enhance kimi.agent.wrapper.sh with auto-model selection</name>
  <files>skills/kimi.agent.wrapper.sh</files>
  <action>
Enhance the existing skills/kimi.agent.wrapper.sh with intelligent model selection:

1. Add new constants at the top:
   - AUTO_MODEL_ENABLED=false (default)
   - CONFIDENCE_THRESHOLD=75
   - COST_THRESHOLD=10000

2. Add new command-line options:
   - --auto-model: Enable automatic model selection
   - --show-cost: Display cost estimate before delegation
   - --confidence-threshold N: Set threshold (default: 75)

3. Add auto_select_model(prompt) function:
   - Extract file paths from prompt (regex: [alnum/_./-]+\.[alnum]+)
   - Call skills/kimi-model-selector.sh with --task and --files
   - Parse JSON output
   - Return selected model

4. Add estimate_and_display_cost(prompt, model) function:
   - Call skills/kimi-cost-estimator.sh
   - Display cost to stderr
   - Return cost units

5. Modify main execution flow:
   - If --auto-model is set:
     a. Check KIMI_FORCE_MODEL first (override)
     b. Call auto_select_model to get recommendation
     c. Get confidence score
     d. If --show-cost or confidence < threshold: estimate and display cost
     e. If confidence < threshold: warn user but proceed
     f. Use selected model for delegation
   - Otherwise: use existing -m/--model behavior

6. Update usage/help text to document new options

7. Add logging for model selection decisions to stderr:
   - [model-selection] Selected: k2 (confidence: 85%)
   - [model-selection] Cost estimate: ~2500 tokens (moderate)
   - [model-selection] Override active: k2.5

Preserve all existing functionality. Changes should be additive only.
  </action>
  <verify>bash -n skills/kimi.agent.wrapper.sh && echo "Syntax OK"</verify>
  <done>Wrapper enhanced with --auto-model, --show-cost, --confidence-threshold options, auto_select_model function, and cost estimation integration</done>
</task>

<task type="auto">
  <name>Task 3: Add context preservation via session management</name>
  <files>skills/kimi.agent.wrapper.sh</files>
  <action>
Add context preservation to the wrapper using kimi CLI --session flag:

1. Add new constant: SESSION_ID="${KIMI_SESSION_ID:-}" (allow user override)

2. Add new option: --session-id ID (explicit session ID)

3. Implement get_session_id() function:
   - If KIMI_SESSION_ID is set: use that
   - If --session-id provided: use that
   - Otherwise: generate from timestamp + random: "kimi-$(date +%s)-$RANDOM"
   - Store in temp file for persistence: /tmp/kimi-session-$$

4. Implement persist_session_id() function:
   - Save session ID to /tmp/kimi-session-$$
   - Set trap to clean up on exit

5. Modify command construction:
   - Add --session "$SESSION_ID" to kimi CLI args when SESSION_ID is set
   - This maintains conversation context across related delegations

6. Add logging:
   - [session] Using session: $SESSION_ID

7. Update help text with session documentation

The session ID allows kimi CLI to maintain context across multiple invocations, which is important for related tasks.
  </action>
  <verify>bash -n skills/kimi.agent.wrapper.sh && echo "Syntax OK"</verify>
  <done>Wrapper supports --session-id option, KIMI_SESSION_ID env var, generates session IDs when not provided, passes --session to kimi CLI</done>
</task>

</tasks>

<verification>
1. Cost estimator has valid syntax: `bash -n skills/kimi-cost-estimator.sh`
2. Cost estimation works: `./skills/kimi-cost-estimator.sh --prompt "test" --model k2` outputs token estimate
3. K2.5 multiplier works: `./skills/kimi-cost-estimator.sh --prompt "test" --model k2.5` shows higher cost than k2
4. Wrapper syntax valid: `bash -n skills/kimi.agent.wrapper.sh`
5. Wrapper help shows new options: `./skills/kimi.agent.wrapper.sh --help | grep -E "auto-model|show-cost|session"`
6. Auto-model flag works: `./skills/kimi.agent.wrapper.sh --auto-model --dry-run "refactor test.py"` shows k2 selection
7. Session ID works: `./skills/kimi.agent.wrapper.sh --session-id test123 --dry-run "test" | grep -q "test123"`
</verification>

<success_criteria>
- Cost estimator correctly calculates tokens (chars/4) and applies model multiplier
- Wrapper accepts --auto-model flag and uses model selector
- Wrapper displays cost estimates when --show-cost or low confidence
- Context preservation works via --session-id and KIMI_SESSION_ID
- All existing wrapper functionality preserved
- New features logged to stderr with appropriate prefixes
</success_criteria>

<output>
After completion, create `.planning/phases/10-enhanced-skill/10-03-SUMMARY.md`
</output>
