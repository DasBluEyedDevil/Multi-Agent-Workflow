---
phase: 02-agent-roles
plan: 03
type: execute
wave: 3
depends_on: []
files_modified: []
autonomous: true
user_setup: []

must_haves:
  truths:
    - "All 7 agent configurations are syntactically valid"
    - "Analysis roles cannot execute shell commands (verified via kimi --agent)"
    - "Action roles can execute shell commands (verified via kimi --agent)"
    - "All agents produce structured output with 4 required sections"
  artifacts:
    - path: ".kimi/agents/"
      provides: "All 7 agent YAML files ready for use"
      count: 7
    - path: "test output"
      provides: "Verification that roles work correctly"
  key_links:
    - from: "kimi CLI"
      to: "agent files"
      via: "--agent-file or --agent flag"
---

<objective>
Verify all 7 agent configurations work correctly: YAML syntax is valid, roles can be invoked, tool restrictions work for analysis roles, and structured output is produced.

Purpose: Ensure the agent infrastructure is functional and meets all requirements before marking Phase 2 complete.
Output: Verification results confirming all agents work as specified.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/02-agent-roles/02-RESEARCH.md
@.planning/phases/02-agent-roles/02-01-SUMMARY.md
@.planning/phases/02-agent-roles/02-02-SUMMARY.md
@.planning/STATE.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Validate all YAML syntax</name>
  <files>
    .kimi/agents/reviewer.yaml
    .kimi/agents/security.yaml
    .kimi/agents/auditor.yaml
    .kimi/agents/debugger.yaml
    .kimi/agents/refactorer.yaml
    .kimi/agents/implementer.yaml
    .kimi/agents/simplifier.yaml
  </files>
  <action>
    Validate YAML syntax for all 7 agent files:
    1. Use python3 to parse each YAML file
    2. Verify each has: version: 1, agent.extend: default, agent.name, agent.system_prompt_path
    3. Verify analysis roles have exclude_tools array with Shell, WriteFile, StrReplaceFile
    4. Verify action roles have NO exclude_tools
    5. Report any validation failures
    
    Commands:
    ```bash
    python3 -c "import yaml; yaml.safe_load(open('.kimi/agents/reviewer.yaml'))" && echo "reviewer.yaml: OK"
    # Repeat for all 7 files
    ```
    
    Create validation report listing each file and its status.
  </action>
  <verify>
    All 7 YAML files pass python3 yaml validation
  </verify>
  <done>
    Validation report confirms all 7 files have valid YAML structure with correct fields
  </done>
</task>

<task type="auto">
  <name>Task 2: Test agent invocation</name>
  <files></files>
  <action>
    Test that kimi CLI can load each agent configuration:
    1. Run `kimi --agent-file .kimi/agents/reviewer.yaml --help` to verify agent loads
    2. Repeat for all 7 agent files
    3. If kimi CLI is not available, document that manual verification is needed
    
    Note: This may fail if kimi CLI is not installed - that's acceptable, document the limitation.
    
    Create invocation test report.
  </action>
  <verify>
    Either: (a) all agents load successfully via kimi CLI, OR (b) report documents why CLI testing wasn't possible
  </verify>
  <done>
    Agent invocation tested and documented (success or limitation noted)
  </done>
</task>

<task type="auto">
  <name>Task 3: Verify tool restrictions</name>
  <files>
    .kimi/agents/reviewer.yaml
    .kimi/agents/security.yaml
    .kimi/agents/auditor.yaml
  </files>
  <action>
    Document tool restriction verification:
    1. Confirm analysis roles have exclude_tools with:
       - kimi_cli.tools.shell:Shell
       - kimi_cli.tools.file:WriteFile
       - kimi_cli.tools.file:StrReplaceFile
       - kimi_cli.tools.plan:SetTodoList
       - kimi_cli.tools.agent:CreateSubagent
    2. Confirm action roles have NO exclude_tools (full access)
    3. Note: Full verification requires running kimi CLI with test commands - document this gap
    
    Create tool restriction verification report.
  </action>
  <verify>
    YAML inspection confirms analysis roles have Shell/WriteFile/StrReplaceFile excluded
  </verify>
  <done>
    Tool restrictions documented and verified via YAML inspection
  </done>
</task>

<task type="auto">
  <name>Task 4: Verify structured output in prompts</name>
  <files>
    .kimi/agents/reviewer.md
    .kimi/agents/security.md
    .kimi/agents/auditor.md
    .kimi/agents/debugger.md
    .kimi/agents/refactorer.md
    .kimi/agents/implementer.md
    .kimi/agents/simplifier.md
  </files>
  <action>
    Verify all system prompts have required output structure:
    1. Check each .md file contains exactly these sections:
       - ## SUMMARY
       - ## FILES
       - ## ANALYSIS
       - ## RECOMMENDATIONS
    2. Check for "MUST use this exact structure" or similar enforcement language
    3. Verify debugger has "Commands executed" requirement
    4. Verify implementer has greenfield freedom statement
    5. Verify all use ${KIMI_WORK_DIR} and ${KIMI_NOW}
    6. Verify all have "subagent reporting back to Claude"
    
    Create structured output verification report.
  </action>
  <verify>
    grep confirms all 4 sections exist in all 7 markdown files
  </verify>
  <done>
    All system prompts verified to have complete structured output format
  </done>
</task>

</tasks>

<verification>
- [ ] All 7 YAML files pass syntax validation
- [ ] Agent invocation tested (or limitation documented)
- [ ] Tool restrictions verified via YAML inspection
- [ ] All 7 system prompts have SUMMARY/FILES/ANALYSIS/RECOMMENDATIONS
- [ ] Debugger has audit trail requirement
- [ ] Implementer has greenfield freedom
- [ ] All prompts use ${KIMI_WORK_DIR} and ${KIMI_NOW}
- [ ] All prompts include subagent constraint
</verification>

<success_criteria>
- All 7 agent configurations validated and documented
- YAML syntax verified for all files
- Tool restrictions confirmed (analysis roles read-only)
- Structured output format confirmed in all prompts
- Phase 2 requirements fully satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/02-agent-roles/02-03-SUMMARY.md`
</output>
