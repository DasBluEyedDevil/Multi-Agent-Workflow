---
phase: 08-mcp-bridge
plan: 05
type: execute
wave: 5
depends_on:
  - 08-04
files_modified:
  - bin/kimi-mcp
  - install.sh (modifications)
autonomous: true
user_setup:
  - service: MCP Server
    why: "Users need to add MCP server to their PATH or use via full path"
    env_vars: []
    dashboard_config: []

must_haves:
  truths:
    - "kimi-mcp CLI command exists and can start the MCP server"
    - "kimi-mcp --help shows usage information"
    - "kimi-mcp --version shows version"
    - "kimi-mcp start launches the MCP server"
    - "Install script installs the MCP bridge components"
  artifacts:
    - path: "bin/kimi-mcp"
      provides: "CLI entry point for MCP server"
      exports: ["start", "--help", "--version"]
  key_links:
    - from: "bin/kimi-mcp"
      to: "mcp-bridge/bin/kimi-mcp-server"
      via: "exec"
      pattern: "exec.*kimi-mcp-server"
---

<objective>
Create the CLI entry point (kimi-mcp) and integrate MCP bridge into the install script.

Purpose: Users need a simple way to start the MCP server and install the components.
Output: CLI wrapper and install script updates.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/phases/08-mcp-bridge/08-CONTEXT.md

# Requirements from ROADMAP.md:
# - CONF-09: CLI command to start MCP server

# From existing project structure:
# - bin/ directory contains CLI commands
# - install.sh installs components
# - Skills are installed to ~/.config/opencode/get-shit-done/skills/
</context>

<tasks>

<task type="auto">
  <name>Create kimimcp CLI wrapper</name>
  <files>bin/kimi-mcp</files>
  <action>
Create bin/kimi-mcp as the CLI entry point for the MCP server.

Shebang: #!/usr/bin/env bash

The script should support:

Usage: kimi-mcp [command] [options]

Commands:
  start           Start the MCP server (default)
  --help, -h      Show help message
  --version, -v   Show version

Implementation:

```bash
#!/usr/bin/env bash
set -e

# Determine installation directory
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(dirname "$SCRIPT_DIR")"

# Version
VERSION="1.0.0"

# Help message
show_help() {
    cat << 'EOF'
Kimi MCP Server - Expose Kimi as MCP tools

Usage: kimi-mcp [command]

Commands:
  start           Start the MCP server (reads JSON-RPC from stdin)
  --help, -h      Show this help message
  --version, -v   Show version information

Environment Variables:
  KIMI_MCP_MODEL       Default model (k2 or k2.5)
  KIMI_MCP_TIMEOUT     Default timeout in seconds

Configuration:
  ~/.config/kimi-mcp/config.json

Examples:
  # Start server
  kimi-mcp start

  # Test with a simple request
  echo '{"jsonrpc":"2.0","id":1,"method":"initialize"}' | kimi-mcp

For more information: https://github.com/dasblitz/climi
EOF
}

# Show version
show_version() {
    echo "kimi-mcp version $VERSION"
    echo "Protocol version: 2025-11-25"
}

# Start server
start_server() {
    local server_path="${PROJECT_ROOT}/mcp-bridge/bin/kimi-mcp-server"
    
    if [[ ! -f "$server_path" ]]; then
        echo "Error: MCP server not found at $server_path" >&2
        echo "Please run install.sh to install MCP bridge components" >&2
        exit 1
    fi
    
    exec "$server_path"
}

# Main
case "${1:-start}" in
    start)
        start_server
        ;;
    --help|-h)
        show_help
        ;;
    --version|-v)
        show_version
        ;;
    *)
        echo "Unknown command: $1" >&2
        echo "Run 'kimi-mcp --help' for usage" >&2
        exit 1
        ;;
esac
```

Make executable: chmod +x bin/kimi-mcp
  </action>
  <verify>chmod +x bin/kimi-mcp && ./bin/kimi-mcp --version | grep -q "1.0.0" && echo "OK"</verify>
  <done>CLI wrapper exists, is executable, and responds to --version and --help</done>
</task>

<task type="auto">
  <name>Update install.sh for MCP bridge</name>
  <files>install.sh</files>
  <action>
Read install.sh and add MCP bridge installation.

Add a new section for MCP bridge installation:

1. After the existing skill installation, add:

```bash
# Install MCP Bridge
install_mcp_bridge() {
    log_info "Installing MCP Bridge..."
    
    # Create MCP bridge directories
    mkdir -p "$INSTALL_DIR/mcp-bridge/lib"
    mkdir -p "$INSTALL_DIR/mcp-bridge/config"
    mkdir -p "$INSTALL_DIR/mcp-bridge/tests"
    mkdir -p "$INSTALL_DIR/bin"
    
    # Copy MCP bridge files
    cp -r "$PROJECT_ROOT/mcp-bridge/lib" "$INSTALL_DIR/mcp-bridge/"
    cp -r "$PROJECT_ROOT/mcp-bridge/config" "$INSTALL_DIR/mcp-bridge/"
    cp "$PROJECT_ROOT/mcp-bridge/bin/kimi-mcp-server" "$INSTALL_DIR/mcp-bridge/bin/"
    chmod +x "$INSTALL_DIR/mcp-bridge/bin/kimi-mcp-server"
    
    # Copy CLI wrapper
    cp "$PROJECT_ROOT/bin/kimi-mcp" "$INSTALL_DIR/bin/"
    chmod +x "$INSTALL_DIR/bin/kimi-mcp"
    
    # Create user config directory
    mkdir -p "$HOME/.config/kimi-mcp"
    
    # Copy default config if user config doesn't exist
    if [[ ! -f "$HOME/.config/kimi-mcp/config.json" ]]; then
        cp "$INSTALL_DIR/mcp-bridge/config/default.json" "$HOME/.config/kimi-mcp/config.json"
        log_info "Created default config at ~/.config/kimi-mcp/config.json"
    fi
    
    log_success "MCP Bridge installed"
}
```

2. Call install_mcp_bridge in the main install flow after skill installation.

3. Add to the PATH setup section (if applicable):
   - Mention that bin/kimi-mcp is available

4. Update the summary output to mention MCP bridge.

Preserve all existing install.sh functionality.
  </action>
  <verify>grep -q "install_mcp_bridge" install.sh && grep -q "kimi-mcp" install.sh && echo "OK"</verify>
  <done>install.sh updated to install MCP bridge components and CLI wrapper</done>
</task>

<task type="auto">
  <name>Create quick start documentation</name>
  <files>mcp-bridge/README.md</files>
  <action>
Create mcp-bridge/README.md with quick start guide for the MCP bridge.

Content:

```markdown
# Kimi MCP Bridge

Expose Kimi K2.5 as MCP (Model Context Protocol) tools for external AI systems.

## Installation

The MCP bridge is installed automatically with:
```bash
./install.sh
```

## Quick Start

### Start the MCP Server

```bash
kimi-mcp start
```

Or directly:
```bash
./mcp-bridge/bin/kimi-mcp-server
```

### Test the Server

```bash
# Initialize
echo '{"jsonrpc":"2.0","id":1,"method":"initialize","params":{"protocolVersion":"2025-11-25"}}' | kimi-mcp

# List tools
echo '{"jsonrpc":"2.0","id":2,"method":"tools/list"}' | kimi-mcp

# Call analyze tool
echo '{
  "jsonrpc": "2.0",
  "id": 3,
  "method": "tools/call",
  "params": {
    "name": "kimi_analyze",
    "arguments": {
      "prompt": "Explain this code",
      "files": ["./example.js"]
    }
  }
}' | kimi-mcp
```

## Configuration

Edit `~/.config/kimi-mcp/config.json`:

```json
{
  "model": "k2",
  "timeout": 30,
  "max_file_size": 1048576
}
```

Or use environment variables:
- `KIMI_MCP_MODEL` - Default model (k2 or k2.5)
- `KIMI_MCP_TIMEOUT` - Timeout in seconds

## Available Tools

- `kimi_analyze` - Analyze code with specified role
- `kimi_implement` - Implement features/fixes
- `kimi_refactor` - Refactor with safety checks
- `kimi_verify` - Verify against requirements

## Testing

```bash
cd mcp-bridge
./tests/run-tests.sh
```
```

Make it concise but complete.
  </action>
  <verify>test -f mcp-bridge/README.md && grep -q "kimi_analyze" mcp-bridge/README.md && echo "OK"</verify>
  <done>README.md exists with installation, configuration, and usage instructions</done>
</task>

</tasks>

<verification>
- bin/kimi-mcp exists and is executable
- CLI supports start, --help, --version commands
- install.sh installs MCP bridge components
- User config directory is created during install
- Default config is copied if not exists
- README.md provides quick start guide
</verification>

<success_criteria>
1. bin/kimi-mcp CLI wrapper exists and works
2. install.sh installs mcp-bridge/ directory structure
3. install.sh creates ~/.config/kimi-mcp/ with default config
4. CLI wrapper can start the MCP server
5. README.md documents usage and configuration
6. All components are executable after install
</success_criteria>

<output>
After completion, create `.planning/phases/08-mcp-bridge/08-05-SUMMARY.md`
</output>
