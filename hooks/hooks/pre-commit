#!/bin/bash
#
# Pre-commit hook: Analyze staged files and offer auto-fixes
#
# This hook runs before commits and analyzes staged files for issues.
# It can automatically fix issues if auto_fix is enabled in configuration.
#

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
HOOKS_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"

source "$HOOKS_ROOT/lib/hooks-config.sh"
source "$HOOKS_ROOT/lib/hooks-common.sh"

# Initialize hook
if ! hooks_init "pre-commit"; then
    exit 0
fi

# Get staged files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)
if [[ -z "$STAGED_FILES" ]]; then
    hooks_log_info "No staged files to check"
    exit 0
fi

# Filter to matching patterns
MATCHING_FILES=$(hooks_filter_files "$STAGED_FILES")
if [[ -z "$MATCHING_FILES" ]]; then
    hooks_log_info "No matching files to analyze"
    exit 0
fi

hooks_log_info "Kimi is analyzing staged files..."

# Build file list for MCP
FILE_JSON=$(echo "$MATCHING_FILES" | jq -R -s -c 'split("\n") | map(select(length > 0))')

# Run analysis
PROMPT="Analyze these staged files for issues (linting, formatting, type errors, bugs). List any issues found and suggest fixes."
RESULT=$(hooks_run_analysis "$PROMPT" "$FILE_JSON" "")

if [[ -z "$RESULT" ]]; then
    hooks_log_info "No issues found or analysis timed out"
    exit 0
fi

echo ""
echo "Kimi found potential issues:"
echo "$RESULT"
echo ""

# Check if auto-fix is enabled
if [[ "$(hooks_config_auto_fix "pre-commit")" == "true" ]]; then
    hooks_log_info "Auto-fix is enabled. Attempting fixes..."
    
    # Stash unstaged changes to avoid conflicts
    STASHED=false
    if ! git diff --quiet; then
        git stash push -q -m "pre-commit auto-fix stash"
        STASHED=true
    fi
    
    # Run implement to fix issues
    FIX_PROMPT="Fix the issues found in these files: $RESULT"
    hooks_run_implement "$FIX_PROMPT" "$FILE_JSON"
    
    # Stage the fixes
    echo "$MATCHING_FILES" | while IFS= read -r file; do
        [[ -n "$file" ]] && git add "$file" 2>/dev/null || true
    done
    
    # Restore stashed changes
    if [[ "$STASHED" == "true" ]]; then
        git stash pop -q
    fi
    
    hooks_log_info "Fixes applied and staged"
else
    # Interactive mode: inform user
    echo "Run with auto-fix enabled to apply fixes automatically."
    echo "Or use: git commit --no-verify to skip hooks"
fi

exit 0
