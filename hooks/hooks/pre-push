#!/bin/bash
#
# Pre-push hook: Run tests and analyze failures
#
# This hook runs before push and can run tests. If tests fail,
# it analyzes the failures and suggests fixes.
#

REMOTE="$1"
REMOTE_URL="$2"

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
HOOKS_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"

source "$HOOKS_ROOT/lib/hooks-config.sh"
source "$HOOKS_ROOT/lib/hooks-common.sh"

# Initialize hook
if ! hooks_init "pre-push"; then
    exit 0
fi

# Check if test running is enabled
if [[ "$(hooks_config_get "hooks.pre-push.run_tests")" != "true" ]]; then
    hooks_log_info "Test running disabled in config"
    exit 0
fi

# Get test command
TEST_CMD=$(hooks_config_get "hooks.pre-push.test_command")
if [[ -z "$TEST_CMD" || "$TEST_CMD" == "null" ]]; then
    hooks_log_debug "No test command configured"
    exit 0
fi

hooks_log_info "Running tests: $TEST_CMD"

# Run tests and capture output
TEST_OUTPUT=$(mktemp)
TEST_EXIT=0

if eval "$TEST_CMD" > "$TEST_OUTPUT" 2>&1; then
    hooks_log_info "Tests passed!"
    rm -f "$TEST_OUTPUT"
    exit 0
else
    TEST_EXIT=$?
fi

# Tests failed
hooks_log_error "Tests failed (exit code: $TEST_EXIT)"

# Check if auto-fix is enabled
if [[ "$(hooks_config_auto_fix "pre-push")" != "true" ]]; then
    echo ""
    echo "Test output:"
    cat "$TEST_OUTPUT"
    echo ""
    echo "Run with auto_fix enabled to attempt automatic fixes."
    rm -f "$TEST_OUTPUT"
    exit 1
fi

# Get files being pushed
PUSH_FILES=$(git diff --name-only @{push}..HEAD 2>/dev/null || \
             git diff --name-only origin/HEAD..HEAD 2>/dev/null || \
             git diff --name-only HEAD~10..HEAD 2>/dev/null || true)

if [[ -z "$PUSH_FILES" ]]; then
    hooks_log_info "Could not determine files being pushed"
    rm -f "$TEST_OUTPUT"
    exit 1
fi

MATCHING_FILES=$(hooks_filter_files "$PUSH_FILES")
if [[ -z "$MATCHING_FILES" ]]; then
    hooks_log_info "No matching files to analyze"
    rm -f "$TEST_OUTPUT"
    exit 1
fi

hooks_log_info "Asking Kimi to analyze test failures..."

# Build file list and context
FILE_JSON=$(echo "$MATCHING_FILES" | jq -R -s -c 'split("\n") | map(select(length > 0))')
TEST_CONTENT=$(cat "$TEST_OUTPUT")
CONTEXT="Test command: $TEST_CMD

Test output:
$TEST_CONTENT"

# Run analysis
PROMPT="These tests failed. Analyze the test output and the relevant source files to identify the root cause and suggest fixes."
RESULT=$(hooks_run_analysis "$PROMPT" "$FILE_JSON" "$CONTEXT")

if [[ -n "$RESULT" ]]; then
    echo ""
    echo "=== Kimi's Analysis ==="
    echo "$RESULT"
    echo "======================="
    echo ""
    
    if [[ "$(hooks_config_is_dry_run)" == "true" ]]; then
        hooks_log_info "Dry-run mode: not applying fixes"
    else
        hooks_log_info "Attempting to apply fixes..."
        FIX_PROMPT="Fix the test failures: $RESULT"
        hooks_run_implement "$FIX_PROMPT" "$FILE_JSON"
        hooks_log_info "Fixes applied. Please review and re-run tests."
    fi
fi

rm -f "$TEST_OUTPUT"
exit 1  # Still fail push so user can review
