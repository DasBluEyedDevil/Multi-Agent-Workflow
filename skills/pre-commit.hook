#!/bin/bash
# Gemini Pre-Commit Verification Hook
# Automatically runs Gemini verification on staged changes before commit
#
# Installation:
#   1. Copy this file to .git/hooks/pre-commit
#   2. Make it executable: chmod +x .git/hooks/pre-commit
#   3. Ensure gemini CLI is installed and configured
#
# Configuration (environment variables):
#   GEMINI_PRECOMMIT_ENABLED=1   # Enable/disable hook (default: 1)
#   GEMINI_PRECOMMIT_STRICT=0    # Fail on warnings too (default: 0)
#   GEMINI_PRECOMMIT_ROLE=verify # Role to use (default: reviewer)

set -e

# Configuration
ENABLED="${GEMINI_PRECOMMIT_ENABLED:-1}"
STRICT="${GEMINI_PRECOMMIT_STRICT:-0}"
ROLE="${GEMINI_PRECOMMIT_ROLE:-reviewer}"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
NC='\033[0m'

# Skip if disabled
if [ "$ENABLED" != "1" ]; then
    exit 0
fi

# Check if gemini wrapper exists
WRAPPER="./skills/gemini.agent.wrapper.sh"
if [ ! -f "$WRAPPER" ]; then
    echo -e "${YELLOW}‚ö† Gemini wrapper not found, skipping pre-commit verification${NC}"
    exit 0
fi

# Get staged files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACMR)
if [ -z "$STAGED_FILES" ]; then
    exit 0
fi

echo -e "${CYAN}üîç Running Gemini pre-commit verification...${NC}"
echo ""

# Get the diff
DIFF=$(git diff --cached)

# Build the verification prompt
PROMPT="Pre-commit verification for staged changes.

**Staged Files:**
$STAGED_FILES

**Changes:**
\`\`\`diff
$DIFF
\`\`\`

Please verify:
1. Code follows existing patterns and conventions
2. No obvious bugs or regressions
3. No security issues (hardcoded secrets, SQL injection, etc.)
4. No obvious performance issues

If you find CRITICAL issues, start your response with 'CRITICAL:'.
If you find WARNINGS, start your response with 'WARNING:'.
If everything looks good, start with 'APPROVED:'."

# Run verification
RESULT=$("$WRAPPER" -r "$ROLE" --no-fallback "$PROMPT" 2>&1) || true

# Check result
if echo "$RESULT" | grep -q "^CRITICAL:"; then
    echo -e "${RED}‚ùå Pre-commit verification FAILED${NC}"
    echo ""
    echo "$RESULT"
    echo ""
    echo -e "${RED}Commit blocked. Please fix the critical issues.${NC}"
    echo -e "${YELLOW}To bypass: git commit --no-verify${NC}"
    exit 1
elif echo "$RESULT" | grep -q "^WARNING:" && [ "$STRICT" = "1" ]; then
    echo -e "${YELLOW}‚ö† Pre-commit verification found warnings${NC}"
    echo ""
    echo "$RESULT"
    echo ""
    echo -e "${YELLOW}Commit blocked (strict mode). Please review warnings.${NC}"
    echo -e "${YELLOW}To bypass: git commit --no-verify${NC}"
    exit 1
else
    echo -e "${GREEN}‚úì Pre-commit verification passed${NC}"
    if echo "$RESULT" | grep -q "^WARNING:"; then
        echo -e "${YELLOW}(with warnings - consider reviewing)${NC}"
    fi
fi

exit 0
